<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2020-10-05 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20201005" />
    <meta http-equiv="Content-Language" content="en" />
    <title>DMPC-API : Le connecteur DMP par DEVCOOP &#x2013; Les différentes transactions vers le DMP</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
<meta name="author" content="DEVCOOP"/>
            <meta name="description" 
                  content="La DMPC-API est une interface de programmation écrite en Java, 
                        fournissant une abstraction de haut niveau permettant l exécution 
                        de l ensemble des transactions définies dans le cahier des charges 
                        pour la DMP Compatibilité. 
                        Elle facilite ainsi aux intégrateurs/éditeurs la mise en place des 
                        contraintes fortes demandées pour la DMP Compatibilité. La DMPC-API est un connecteur de la http://www.devbox-sante.fr
"/>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="https://www.devbox-sante.fr/" id="bannerLeft"><img src="https://www.devbox-sante.fr/img/svg/logo-for-whiteBg.svg"  alt="DevBox_Sante"/></a></div>
        <div class="pull-right"><a href="https://www.devbox-sante.fr/connecteurs/dmpc-api" id="bannerRight"><img src="../toolbox-devcoop-dmpc-api-logo.png"  alt="DMPC-API"/></a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2020-10-05<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 3.2-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">DMPC</li>
    <li><a href="../index.html" title="Introduction"><span class="none"></span>Introduction</a>  </li>
    <li><a href="../igc/certificatIGCSante.html" title="Certificats serveurs IGC Santé"><span class="none"></span>Certificats serveurs IGC Santé</a>  </li>
    <li><a href="../docReference.html" title="Liens vers les documentations"><span class="none"></span>Liens vers les documentations</a>  </li>
          <li class="nav-header">Embedded Client</li>
    <li><a href="../embedded/firstStepEmbedded.html" title="Commencer"><span class="none"></span>Commencer</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Transactions supportées</a>
  </li>
    <li><a href="../embedded/howtos/uniqueIdGenerator.html" title="Howto : UniqueId"><span class="none"></span>Howto : UniqueId</a>  </li>
          <li class="nav-header">Proxy REST</li>
    <li><a href="../proxy-rest/proxy-rest.html" title="Proxy REST / Lancer"><span class="none"></span>Proxy REST / Lancer</a>  </li>
          <li class="nav-header">Proxy WS</li>
    <li><a href="../proxy-ws/firstStepProxyWS.html" title="Proxy WS / Commencer"><span class="none"></span>Proxy WS / Commencer</a>  </li>
    <li><a href="../proxy-ws/configurationServeurProxy.html" title="Proxy WS / Configurer"><span class="none"></span>Proxy WS / Configurer</a>  </li>
          <li class="nav-header">Documents CDA</li>
    <li><a href="../CDA/structurationMinimale.html" title="Structuration Minimale"><span class="none"></span>Structuration Minimale</a>  </li>
    <li><a href="../CDA/crBiologie.html" title="CR Biologie"><span class="none"></span>CR Biologie</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://www.devcoop.fr/" title="DEVCOOP" class="builtBy"><img class="builtBy"  alt="DEVCOOP" src="https://www.devcoop.fr/img/logo.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Les diff&#xe9;rentes transactions vers le DMP</h1>
<p>Toutes transactions vers le DMP se fait en pr&#xe9;cisant un <tt>DMPCContext</tt> et une requ&#xea;te sp&#xe9;cifique en argument d&#x2019;une m&#xe9;thode du <tt>DMPCClient</tt>.</p>
<p>Le <tt>DMPCContext</tt> contient les informations permettant de d&#xe9;finir :&#xa0;</p>

<ul>
  
<li>L&#x2019;auteur de la transaction,</li>
  
<li>Le code de confidentialit&#xe9; de la transaction (connexion secr&#xe8;te, invisible aux repr&#xe9;sentants l&#xe9;gaux du patient)</li>
  
<li>L&#x2019;autorit&#xe9; des cartes vitales utilis&#xe9;es (r&#xe9;elles ou test)</li>
</ul>
<p>&#xc0; ce <tt>DMPCContext</tt> est associ&#xe9; un autre argument d&#xe9;pendant de la transaction r&#xe9;alis&#xe9;e.</p>
<div class="section">
<h2><a name="Mode_dauthentification"></a>Mode d&#x2019;authentification</h2>
<div class="section">
<h3><a name="Directe_depus_version_3.1"></a>Directe (depus version 3.1)</h3>
<p>En authentification directe, l&#x2019;utilisateur personnel de sant&#xe9; est authentifi&#xe9; par sa carte CPS/CPE, ces informations sont r&#xe9;cup&#xe9;r&#xe9;es lors de la lecture de la carte CPS.</p></div>
<div class="section">
<h3><a name="Indirecte_depuis_version_1.0"></a>Indirecte (depuis version 1.0)</h3>
<p>En authentification indirecte, seule la structure de sant&#xe9; (par son certificat serveur) est authentifi&#xe9;e.</p>
<p>L&#x2019;auteur de la requ&#xea;te, c&#x2019;est &#xe0; dire le personnel de sant&#xe9; utilisateur (<tt>DMPCPersonnelSante</tt>), doit donc &#xea;tre authentifi&#xe9; localement. Le syst&#xe8;me de la structure de sant&#xe9; doit &#xea;tre en mesure d&#x2019;authentifi&#xe9; ses utilisateurs. Cet identifiant local au syst&#xe8;me doit &#xea;tre sp&#xe9;cifi&#xe9; dans <tt>DMPCPersonnelSante.internalId</tt> m&#xea;me si le rpps est connu.</p>
<p>Lors de la lecture de la Carte Vitale, l&#x2019;int&#xe9;grateur doit &#xea;tre en mesure de d&#xe9;finir la provenance du nir (R&#xe9;el, Test, D&#xe9;mo) pass&#xe9; en param&#xe8;tres des diff&#xe9;rentes requ&#xea;tes en pr&#xe9;cisant la valeur <tt>DMPCContext.DMPCInsNirAutorite</tt>.</p>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">DMPCContext context = new DMPCContext();
DMPCPersonnelSante ps = new DMPCPersonnelSante();
ps.setInternalId(&quot;1234567890&quot;);
ps.setNom(&quot;For&#xea;t&quot;);
ps.setPrenom(&quot;Laurent&quot;);
ps.setRole(&quot;10&quot;); // M&#xe9;decin  dans la nomenclature DMPCCode.ASIPJeuxValeurs.SUBJECT_ROLE      
ps.setSpecialite(&quot;G15_10/SM30&quot;); // G15_10/SM30 N&#xe9;phrologie  dans la nomenclature DMPCCode.ASIPJeuxValeurs.AUTHOR_SPECIALITY
ps.setSecteurActivite(&quot;SA01&quot;);  // Etablissement public de sant&#xe9; dans la nomenclature DMPCCode.ASIPJeuxValeurs.HEALTH_CARE_FACILITY_TYPE_CODE
ps.getStructureSante().setNom(&quot;DEVCOOP Bureau de L&#xe9;ognan&quot;);
context.setAuthor(ps);
context.setInsNirAutorite(DMPCContext.DMPCInsNirAutorite.TEST);  // InsNirAutorite EX_GEN-1520 &#xe0; pr&#xe9;ciser lors de tout appel &#xe0; l'api. 
</pre></div></div></div></div>
<div class="section">
<h2><a name="Rcupration_des_diffrents_paramtres_du_DMP"></a>R&#xe9;cup&#xe9;ration des diff&#xe9;rents param&#xe8;tres du DMP</h2>
<div class="section">
<h3><a name="getParametres_depuis_version_3.0"></a>getParametres() (depuis version 3.0)</h3>
<p>Afin de pouvoir r&#xe9;cup&#xe9;rer le param&#xe8;trage du DMP qui permet de r&#xe9;pondre &#xe0; un certain nombre d&#x2019;exigences notamment les fonctions-gestion-mineurs (EX_GEN-1550). Il faut acc&#xe9;der &#xe0; la m&#xe9;thode <tt>getParametres</tt></p>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">  DMPCParametres parametres = dmpcClient.getParametres();

  if (parametres.isFonctionsGestionMineurs() &amp;&amp; agePatient &lt; parametres.getAgeMajorite()) {
    // Attention EX_GEN-1550
  } 
  if (parametres.isProduction()) {
    // Attention l'environnement est celui de production, 
  }
   
  if (!parametres.isCumulInvisiblePatientMasquePs()) {
   // Attention EX_2.1-1050
  }
</pre></div></div></div>
<div class="section">
<h3><a name="getCodesFor_depuis_version_1.0"></a>getCodesFor() (depuis version 1.0)</h3>
<p>M&#xe9;thode permettant d&#x2019;acc&#xe9;der aux diff&#xe9;rents jeux de valeurs impos&#xe9;s par le Guide d&#x2019;int&#xe9;gration.</p>
<p>notamment :</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">public enum ASIPJeuxValeurs {

        QUALITE_REPRESENTANT_LEGAL,
        AUTHOR_SPECIALITY,
        CLASS_CODE,
        CONFIDENTIALITY_CODE,
        CONTENT_TYPE_CODE,
        FORMAT_CODE,
        HEALTH_CARE_FACILITY_TYPE_CODE,
        PRACTICE_SETTING_CODE,
        SUBJECT_ROLE,
        TYPE_CODE,
        RESTRICTION_AUDIENCE_VIHF
    }
</pre></div></div>
<p>Exemple :</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">    List&lt;DMPCCode&gt; allPersonnelDeSanteSpecialities = client.getCodesFor(DMPCCode.ASIPJeuxValeurs.AUTHOR_SPECIALITY);
    List&lt;DMPCCode&gt; allPossibleFormatCodesForADocument = client.getCodesFor(DMPCCode.ASIPJeuxValeurs.FORMAT_CODE);
</pre></div></div></div></div>
<div class="section">
<h2><a name="Transactions_didentification_du_patient"></a>Transactions d&#x2019;identification du patient</h2>
<div class="section">
<h3><a name="TD_0.0_:_Acquisition_de_lidentit_du_patient_depuis_version_3.0"></a>TD 0.0 : Acquisition de l&#x2019;identit&#xe9; du patient (depuis version 3.0)</h3>
<p>Cette fonctionnalit&#xe9; permet au LPS d&#x2019;acqu&#xe9;rir l&#x2019;identit&#xe9; du patient et de d&#xe9;clencher les m&#xe9;canismes d&#x2019;identito-vigilance. Avant le premier acc&#xe8;s au DMP d&#x2019;un patient via les interfaces LPS v2 du syst&#xe8;me DMP, le LPS :</p>

<ul>
  
<li>acquiert l&#x2019;INS et les traits d&#x2019;identit&#xe9; du patient (cf. RG_0110) via la transaction TD0.0,</li>
  
<li>d&#xe9;clenche les m&#xe9;canismes d&#x2019;identito-vigilance en utilisant les donn&#xe9;es d&#x2019;identification du patient fournies par la transaction TD0.0 (cf. RG_0130).</li>
  
<li>d&#xe9;termine le statut de l&#x2019;INS du patient (cf. RG_0140).</li>
</ul>
<p>Pour les acc&#xe8;s suivants, le LPS acquiert l&#x2019;INS du patient stock&#xe9; en base locale.</p>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">final TD00Request td00Request = new TD00Request();
td00Request.setDateNaissance(&quot;2011-06-07&quot;);
td00Request.setNirOuvrantDroit(new DMPCNir(&quot;211066322074514&quot;));
td00Request.setNirIndividu(new DMPCNir(&quot;150060475546974&quot;));
final TD00Response td00Response = client.td00Identity(context, td00Request);
if (td00Response == null) {
    throw new RuntimeException(&quot;L'ayant droit n'existe pas&quot;);
}
</pre></div></div></div>
<div class="section">
<h3><a name="TD0.2_:_test_dexistence_du_DMP_dun_patient_et_vrification_de_lautorisation_daccs_depuis_version_1.0"></a>TD0.2 : test d&#x2019;existence du DMP d&#x2019;un patient et v&#xe9;rification de l&#x2019;autorisation d&#x2019;acc&#xe8;s (depuis version 1.0)</h3>
<p>Cette transaction permet de tester l&#x2019;existence d&#x2019;un DMP et de v&#xe9;rifier les autorisations d&#x2019;acc&#xe8;s ainsi que de r&#xe9;cup&#xe9;rer les informations concernant la cr&#xe9;ation du compte patient.</p>
<p>De l&#xe0; peut en d&#xe9;couler des actions de cr&#xe9;ations de DMP, de cr&#xe9;ation de compte internet, ou bien encore de conna&#xee;tre la raison d&#x2019;une interdiction d&#x2019;acc&#xe8;s</p>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">TD02Response response = client.td02Exist(context, new TD02Request(&quot;211066322074514&quot;));
if (response.getAutorisation().equals(EXPIRE)) {
    // pr&#xe9;voir une client.td03AddAuthorization()
} else if (response.getAutorisation().equals(INTERDIT)) {
    // le PS ne peut acc&#xe9;der au DMP
    final String raison = response.getRaison();
} else if (response.getAutorisation().equals(NON_EXISTE)) {
    // pr&#xe9;voir une client.td03AddAuthorization()
} else if (response.getAutorisation().equals(VALIDE)) {
    if (!response.getCompteInternetOuvert()) {
        // pr&#xe9;vour une client.td15aCreerAccesInternetPatient()
    }
    // contient les informations patient stock&#xe9;es dans leDMP
    final DMPCPatient dmpPatient = response.getPatient();
    if (response.getRole().equals(DMPCRole.MEDECIN_TRAITANT)) {
        // le PS author est le m&#xe9;decint traitant
    } 
}
</pre></div></div></div>
<div class="section">
<h3><a name="TD0.3_:modifier_lautorisation_daccs_etou_le_statut_mdecin_traitant_DMP_ou_passer_en_mode_daccs__bris_de_glace__depuis_version_2.0"></a>TD0.3 :&#xa0;modifier l&#x2019;autorisation d&#x2019;acc&#xe8;s et/ou le statut m&#xe9;decin traitant DMP ou passer en mode d&#x2019;acc&#xe8;s &#xab; bris de glace &#xbb; (depuis version 2.0)</h3>
<p>Le LPS permet &#xe0; l&#x2019;utilisateur les actions suivantes.</p>

<ul>
  
<li>Ajouter une autorisation d&#x2019;acc&#xe8;s au DMP du patient ou passer en mode d&#x2019;acc&#xe8;s &#xab; bris de glace &#xbb;. Cf. DMP_0.3a.</li>
  
<li>Supprimer une autorisation d&#x2019;acc&#xe8;s au DMP du patient. Cf. DMP_0.3b.</li>
  
<li>Modifier le statut m&#xe9;decin traitant DMP. Cf. DMP_0.3c.</li>
</ul>
<p>Exemple :&#xa0;</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">client.td03AddAuthorization(context, new TD03Request(&quot;211066322074514&quot;, DMPCRole.STANDARD));
client.td03RemoveAuthorization(context, new TD03Request(patient.getIns(), DMPCRole.STANDARD));
client.td03AddAuthorization(context, new TD03Request(patient.getIns(), DMPCRole.MEDECIN_TRAITANT));
</pre></div></div></div>
<div class="section">
<h3><a name="TD0.4"></a>TD0.4</h3>
<p>Non requis pour le DMP</p></div>
<div class="section">
<h3><a name="TD0.5"></a>TD0.5</h3>
<p>Non requis pour le DMP</p></div>
<div class="section">
<h3><a name="TD1.1_:_crer_un_DMP_depuis_version_2.0"></a>TD1.1 : cr&#xe9;er un DMP (depuis version 2.0)</h3>
<p>Cette fonctionnalit&#xe9; permet de cr&#xe9;er le DMP d&#x2019;un patient. Le LPS :</p>

<ul>
  
<li>contr&#xf4;le les pr&#xe9;requis &#xe0; la cr&#xe9;ation du DMP du patient (cf. RG_1010),</li>
  
<li>acquiert les donn&#xe9;es administratives du patient (cf. RG_1020),</li>
  
<li>acquiert le statut du DMP &#xe0; cr&#xe9;er (cf. RG_1030),</li>
  
<li>acquiert l&#x2019;adresse postale du patient (cf. RG_1040),</li>
  
<li>acquiert la date de naissance du patient (cf. RG_1050),</li>
  
<li>acquiert les donn&#xe9;es concernant le repr&#xe9;sentant l&#xe9;gal du patient (cf. RG_1060),</li>
  
<li>acquiert le consentement du patient &#xe0; la cr&#xe9;ation de son DMP (cf. RG_1070),</li>
  
<li>acquiert la demande d&#x2019;ajout du statut m&#xe9;decin traitant DMP (cf. RG_1080),</li>
  
<li>acquiert le consentement du patient &#xe0; l&#x2019;acc&#xe8;s &#xe0; son DMP en mode &#xab; bris de glace &#xbb; et en mode &#xab; centre de r&#xe9;gulation &#xbb; (cf. RG_1090),</li>
  
<li>cr&#xe9;e le DMP du patient (cf. RG_1100 et TD1.1),</li>
  
<li>ajoute statut m&#xe9;decin traitant DMP (cf. RG_1110 et TD0.3),</li>
  
<li>acquiert la demande d&#x2019;activation du compte internet du patient ou d&#xe9;clenche automatiquement l&#x2019;activation du compte internet du patient (cf. RG_1120),</li>
  
<li>G&#xe9;n&#xe9;re un &#xab; document d&#x2019;accus&#xe9; de cr&#xe9;ation du DMP &#xbb; en l&#x2019;absence d&#x2019;activation du compte internet du patient (cf. RG_1130).</li>
</ul>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">// td00&#xa0;requise avant cr&#xe9;ation d'un DMP
final TD00Request td00Request = new TD00Request();
td00Request.setDateNaissance(&quot;2011-06-07&quot;);
td00Request.setNirOuvrantDroit(new DMPCNir(&quot;211066322074514&quot;));
td00Request.setNirIndividu(new DMPCNir(&quot;150060475546974&quot;));
final TD00Response td00Response = client.td00Identity(context, td00Request);
if (td00Response == null) {
    throw new RuntimeException(&quot;L'ayant droit n'existe pas&quot;);
}

final DMPCCarteVitaleInfo carteVitaleInfo = new DMPCCarteVitaleInfo();
carteVitaleInfo.setDateNaissance(td00Response.getInfoPatient().getDateNaissance().substring(2));
carteVitaleInfo.setNomPatronymique(td00Response.getInfoPatient().getNomPatronymique());
carteVitaleInfo.setNomUsuel(td00Response.getInfoPatient().getNomPatronymique());
carteVitaleInfo.setPrenom(td00Response.getInfoPatient().getPrenom());

TD11Request td11Request = new TD11Request();
td11Request.setCarteVitaleInfo(carteVitaleInfo);

patient.setOrdreDeNaissance(1);
patient.setNomUsuel(&quot;PATB-TROIS&quot;);

final DMPCAdresse adresse = new DMPCAdresse();
adresse.setCodePostal(&quot;33850&quot;);
adresse.setLigneAdresse(&quot;22 rue des &#xe9;delweiss&quot;);
adresse.setComplementAdresse(&quot;compl&#xe9;ment d'adresse&quot;);
adresse.setVille(&quot;LEOGNAN&quot;);
adresse.setPays(&quot;FRANCE&quot;);
patient.setAdresse(adresse);
patient.setCivilite(&quot;M&quot;);
patient.setEmail(&quot;PATB-TROIS@devcoop.fr&quot;);
patient.setMobile(&quot;0663285980&quot;);
patient.setPaysDeNaissance(&quot;FRANCE&quot;);
patient.setSexe(DMPCSexe.M);
patient.setTelephone(&quot;0663285980&quot;);
final DMPCRepresentantLegal representantLegal = new DMPCRepresentantLegal();
representantLegal.setAdresse(adresse);
representantLegal.setCivilite(&quot;M&quot;);
representantLegal.setEmail(&quot;PATB-TROIS-REPRESENTANT@devcoop.fr&quot;);
representantLegal.setMobile(&quot;0663285980&quot;);
representantLegal.setTelephone(&quot;0663285980&quot;);
representantLegal.setNom(patient.getNomPatronymique());
representantLegal.setPrenom(&quot;Representant Legal&quot;);
representantLegal.setQualite(client.getCodesFor(DMPCCode.ASIPJeuxValeurs.QUALITE_REPRESENTANT_LEGAL).get(1).getCode());
patient.setRepresentantLegal(representantLegal);
td11Request.setPatient(patient);
td11Request.setConsentementOuverture(true);
td11Request.setOppositionBrisDeGlace(false);
td11Request.setOppositionUrgence(true);

final TD11Response td11Response = client.td11CreationDmp(context, td11Request);
final DMPCPatient dmpPatient = td11Response.getPatient(); // patient retourn&#xe9; par le DMP
Files.write(td11Response.getFormulairePatient(), new File(&quot;./documentAccuseCreation.pdf&quot;)); // fichier PDF contenant le document des secrets
</pre></div></div></div>
<div class="section">
<h3><a name="TD1.5_:crer_ou_mettre__jour_le_compte_internet_du_patient_depuis_version_2.0"></a>TD1.5 :&#xa0;cr&#xe9;er ou mettre &#xe0; jour le compte internet du patient (depuis version 2.0)</h3>
<p>La fonctionnalit&#xe9; DMP_1.5 permet :</p>

<ul>
  
<li>de cr&#xe9;er le compte internet du patient afin que celui-ci puisse se connecter sur son DMP (DMP_1.5a),</li>
  
<li>d&#x2019;ajouter ou modifier ou supprimer un canal OTP (One Time Password - code d&#x2019;acc&#xe8;s &#xe0; usage unique) (DMP_1.5b),</li>
  
<li>de d&#xe9;bloquer le compte internet patient et de r&#xe9;g&#xe9;n&#xe9;rer les param&#xe8;tres de connexion du patient (DMP_1.5d).</li>
</ul>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">DMPCPatient patient = createDMP();
        
// Cr&#xe9;ation de l'acc&#xe8;s internet
TD15aRequest aRequest = new TD15aRequest();
aRequest.setPatient(patient);
aRequest.setEmail(&quot;laurent.foret@dev.coop&quot;);
TD15aResponse response = client.td15aCreerAccesInternetPatient(context, aRequest);
Files.write(response.getFormulairePatient(), new File(&quot;./target/documentDesSecrets.pdf&quot;));

// Ajout d'un canal OTP
TD15bRequest bRequest = new TD15bRequest();
bRequest.setIns(patient.getIns());
bRequest.setTelephone(&quot;0663285980&quot;);
client.td15bAddCanalOTP(context, bRequest);

// Suppression d'un canal OTP
bRequest = new TD15bRequest();
bRequest.setIns(patient.getIns());
bRequest.setEmail(&quot;laurent.foret@dev.coop&quot;);
client.td15bRemoveCanalOTP(context, bRequest);

// D&#xe9;blocage acc&#xe8;s internet patient
TD15cRequest dRequest = new TD15cRequest();
dRequest.setPatient(patient);
TD15cResponse response = client.td15dDeblocageAccesInternetPatient(context, dRequest);
Files.write(response.getFormulairePatient(), new File(&quot;./target/documentDesSecrets15d110.pdf&quot;));

</pre></div></div></div></div>
<div class="section">
<h2><a name="Alimentation"></a>Alimentation</h2>
<p>Le profil alimentation du DMP se fait au travers de transaction XDS (<a class="externalLink" href="https://wiki.ihe.net/index.php/Cross-Enterprise_Document_Sharing">https://wiki.ihe.net/index.php/Cross-Enterprise_Document_Sharing</a>) support&#xe9;e par le serveur DMP ainsi que par la DMPC-API.</p>
<p>Les transactions XDS&#xa0;permettent de soumettre des documents au format CDA (<a class="externalLink" href="https://www.hl7.org/implement/standards/product_brief.cfm?product_id=7">https://www.hl7.org/implement/standards/product_brief.cfm?product_id=7</a>) support&#xe9; &#xe9;galement par le DMP et la DMPC-API.</p>
<p>La DMPC-API pr&#xe9;sente un mod&#xe8;le simplif&#xe9; des informations demand&#xe9;es et s&#x2019;occupe de la coh&#xe9;rence des m&#xe9;tadonn&#xe9;es des transactions XDS d&#x2019;avec les m&#xe9;tadonn&#xe9;es <a href="../CDA/structurationMinimale.html">des documents CDA</a> )</p>
<div class="section">
<h3><a name="TD2.1_:_alimenter_le_DMP_dun_patient_avec_des_documents_depuis_version_1.0"></a>TD2.1 : alimenter le DMP d&#x2019;un patient avec des documents (depuis version 1.0)</h3>
<p>Cette fonctionnalit&#xe9; permet d&#x2019;alimenter le DMP d&#x2019;un patient avec un ou plusieurs nouveaux documents :</p>

<ul>
  
<li>d&#xe9;crits sous la forme de documents CDA et de m&#xe9;tadonn&#xe9;es XDS,</li>
  
<li>et transmis au syst&#xe8;me DMP sous la forme d&#x2019;un lot de soumission XDS sign&#xe9; (XAdES).</li>
</ul>
<p>La cin&#xe9;matique g&#xe9;n&#xe9;rale est la suivante. Le PS constitue le ou les document(s) dans le LPS . Le LPS :</p>

<ul>
  
<li>construit le ou les document(s)
  
<ul>
    
<li>construit le document au format CDA ==&gt; action r&#xe9;alis&#xe9;e par la DMPC-API</li>
    
<li>alimente les m&#xe9;tadonn&#xe9;es XDS ==&gt; action r&#xe9;alis&#xe9;e par la DMPC-API</li>
  </ul></li>
  
<li>constitue un lot de soumission XDS et signe ce lot (XAdES) ==&gt; action r&#xe9;alis&#xe9;e par la DMPC-API</li>
  
<li>soumet le lot de documents au syst&#xe8;me DMP ==&gt; action r&#xe9;alis&#xe9;e par la DMPC-API</li>
</ul>
<p>Le LPS int&#xe9;grateur de la DMPC-API doit seulement fournir les valeurs des diff&#xe9;rentes m&#xe9;tadonn&#xe9;es li&#xe9;es aux documents et &#xe0; la soumission par l&#x2019;interm&#xe9;diaire d&#x2019;un mod&#xe8;le simplifi&#xe9; :</p>
<p>Exemple : </p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">//   cr&#xe9;ation du document
DMPCDocument document = new DMPCDocument();
document.addConfidentiality(&quot;N&quot;);  // dans la nomenclature DMPCCode.ASIPJeuxValeurs.CONFIDENTIALITY_CODE
document.setComments(&quot;Commentaire du Document&quot;);
document.addEvent(new DMPCCode(&quot;B18&quot;, &quot;2.16.840.1.113883.6.3&quot;, &quot;H&#xe9;patite virale chronique&quot;));
document.setPracticeSetting(&quot;AMBULATOIRE);
document.setServiceStartTime(maintenant.toString());
document.setServiceStopTime(maintenant.toString());
document.setTitle(&quot;Titre du Document&quot;);
document.setType(&quot;11488-4&quot;); // dans la nomenclature DMPCCode.ASIPJeuxValeurs.TYPE_CODE
// document.setClassCode(&quot;&quot;); // non n&#xe9;cessaire car d&#xe9;duit du type code pour la liste des valeurs possibles aller dans la nomenclature DMPCCode.ASIPJeuxValeurs.CLASS_CODE
document.setCreationTime(maintenant.toString());
document.setFormat(&quot;urn:ihe:iti:xds-sd:pdf:2008&quot;);  // dans la nomenclature DMPCCode.ASIPJeuxValeurs.FORMAT_CODE
InputStream input = this.getClass().getClassLoader().getResourceAsStream(&quot;1.pdf&quot;);
byte[] content = new byte[input.available()];
ByteStreams.readFully(input, content);
document.setContent(content);

//    cr&#xe9;ation de la soumission 
DMPCSubmission submission = new DMPCSubmission();
submission.setPatient(patient);
submission.setComments(&quot;Commentaire Soumission du document&quot;);
submission.setContentType(&quot;04&quot;);
submission.setTitle(&quot;Soumission du document&quot;);
//   ajout du document dans la soumission
submission.addDocument(document);

//   envoi de la soumission
TD21Response td21Response = client.td21SubmitDocuments(context, new TD21Request(submission));
System.out.println(&quot;Soumission enregistr&#xe9; avec l'uuid :&quot; + td21Response.getSubmission().getUuid());

for (DMPCDocument submittedDocument : td21Response.getSubmission().getDocuments()) {
    System.out.println(String.format(&quot;Contenant le document ayant pour uniqueId : %s et uuid : %s&quot;,
            submittedDocument.getUniqueId(), submittedDocument.getEntryUuid()));
    document = submittedDocument;
}
</pre></div></div>
<p>Pour une soumission de plusieurs documents, il suffit d&#x2019;ajouter les documents &#xe0; la soumission :</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">submission.addDocument(document1);
submission.addDocument(document2);
</pre></div></div></div>
<div class="section">
<h3><a name="TD3.1b_:_rechercher_lidentifiant_technique_dun_document_depuis_version_3.0"></a>TD3.1b : rechercher l&#x2019;identifiant technique d&#x2019;un document (depuis version 3.0)</h3>
<p>Cette fonctionnalit&#xe9; permet, aux LPS qui n&#x2019;impl&#xe9;mentent pas DMP_3.1a, de rechercher l&#x2019;identifiant technique d&#x2019;un document (dans le syst&#xe8;me DMP) &#xe0; partir de l&#x2019;identifiant local au LPS de ce document. Le LPS peut ensuite supprimer (DMP_3.3c), archiver (DMP_3.3d) ou remplacer un document dans le DMP du patient (DMP_2.1/2.2b).</p>
<p>Exemple :</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">String previousDocumentUniqueId = ...; // uniqueId d'un document envoy&#xe9; pr&#xe9;c&#xe9;demment dans le DMP 
TD31bRequest td31bRequest = new TD31bRequest();
td31bRequest.setDocumentUniqueId(previousDocumentUniqueId());
td31bRequest.setIns(patient.getIns());
TD31bResponse response = client.td31bGetDocumentEntry(context, td31bRequest);

// uuid du document courant stock&#xe9; dans le DMP
String documentCurrentUuid = response.getDocumentUuid();
// permet le remplacement de document avec une td21submit document ou encore une td33cUnpublished.
</pre></div></div>
<p>Exemple de remplacement de document apr&#xe8;s recherche dans le DMP :</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">// r&#xe9;cup&#xe9;ration du uuid du document courant dans le DMP
TD31bRequest td31bRequest = new TD31bRequest();
td31bRequest.setDocumentUniqueId(uniqueIdDuDocumentAremplacer);
td31bRequest.setIns(patient.getIns());
TD31bResponse td31bresponse = client.td31bGetDocumentEntry(context, td31bRequest);

// cr&#xe9;ation de la soummission pour le remplacement
DMPCSubmission submissionRemplace = ...;
DMPCDocument documentRemplace = ...;
// ajout des informations de remplacement dans le document qui remplace
documentRemplace.setReplacementOf(td31bresponse.getDocumentUuid());
documentRemplace.setReplacementOfUniqueId(documentE.getUniqueId());
submissionRemplace.setTitle(&quot;remplacement du document E&quot;);
// envoie de la soummission
client.td21SubmitDocuments(context, new TD21Request(submissionRemplaceE));
</pre></div></div></div>
<div class="section">
<h3><a name="TD33c_:_Supprimer_un_document_depuis_version_1.0"></a>TD33c : Supprimer un document (depuis version 1.0)</h3>
<p>Cette fonctionnalit&#xe9; permet &#xe0; l&#x2019;utilisateur de supprimer un document dans le DMP d&#x2019;un patient. La cin&#xe9;matique g&#xe9;n&#xe9;rale est la suivante :</p>

<ul>
  
<li>L&#x2019;utilisateur indique qu&#x2019;il souhaite supprimer le document s&#xe9;lectionn&#xe9;.</li>
  
<li>L&#x2019;utilisateur confirme l&#x2019;action demand&#xe9;e.</li>
  
<li>Le LPS envoie une requ&#xea;te de mise &#xe0; jour des attributs d&#x2019;un document au syst&#xe8;me DMP</li>
</ul>
<p>Exemple :</p>

<div class="source">
<div class="source"><pre class="prettyprint linenums">TD33CRequest td33cRequest = new TD33CRequest();
td33cRequest.setDocumentUuid(uniqueIdDuDocumentASupprimer);
td33cRequest.setIns(patient.getIns()); 
td33cRequest.setContentType(contentTypeDuDocumentASupprimer); // le contentType est le m&#xea;me que pour une soumission de document.
client.td33cUnpublished(context, td33cRequest);
</pre></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2020.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
